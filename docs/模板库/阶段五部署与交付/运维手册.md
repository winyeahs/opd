# 运维手册

**项目名称**：[项目名称]  
**版本号**：V1.0  
**创建日期**：[YYYY-MM-DD]  
**创建人**：[创建人姓名]

---

## 一、系统概述

### 1.1 系统架构

```mermaid
graph LR
    User[用户] --> LB[负载均衡]
    LB --> Web1[Web服务器1]
    LB --> Web2[Web服务器2]
    Web1 --> App[应用服务器]
    Web2 --> App
    App --> DB[(数据库)]
    App --> Cache[(缓存)]
```

### 1.2 服务器清单

| 服务器 | IP地址 | 角色 | 配置 |
|--------|--------|------|------|
| [服务器1] | [IP] | Web服务器 | [配置] |
| [服务器2] | [IP] | 应用服务器 | [配置] |
| [服务器3] | [IP] | 数据库服务器 | [配置] |

---

## 二、日常运维

### 2.1 服务监控

#### 2.1.1 服务状态检查

```bash
# 检查Nginx状态
systemctl status nginx

# 检查应用服务状态
systemctl status [项目名]

# 检查MySQL状态
systemctl status mysqld

# 检查Redis状态
systemctl status redis
```

#### 2.1.2 进程检查

```bash
# 查看进程
ps -ef | grep nginx
ps -ef | grep java
ps -ef | grep mysql

# 查看端口
netstat -tlnp | grep 80
netstat -tlnp | grep 8080
netstat -tlnp | grep 3306
```

### 2.2 日志管理

#### 2.2.1 日志位置

| 日志类型 | 路径 |
|---------|------|
| 应用日志 | /opt/[项目名]/logs/app.log |
| Nginx访问日志 | /var/log/nginx/access.log |
| Nginx错误日志 | /var/log/nginx/error.log |
| 数据库日志 | /var/log/mysql/error.log |

#### 2.2.2 日志查看

```bash
# 实时查看日志
tail -f /opt/[项目名]/logs/app.log

# 查看最近100行
tail -n 100 /opt/[项目名]/logs/app.log

# 搜索关键字
grep "ERROR" /opt/[项目名]/logs/app.log

# 按时间查看
grep "2024-01-01" /opt/[项目名]/logs/app.log
```

#### 2.2.3 日志轮转

```bash
# 配置日志轮转
vim /etc/logrotate.d/[项目名]
```

**配置示例**：

```
/opt/[项目名]/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
}
```

### 2.3 备份管理

#### 2.3.1 数据库备份

```bash
# 手动备份
mysqldump -u [用户名] -p [数据库名] > backup_$(date +%Y%m%d).sql

# 自动备份脚本
vim /opt/backup/backup_db.sh
```

**备份脚本示例**：

```bash
#!/bin/bash
BACKUP_DIR=/opt/backup
DATE=$(date +%Y%m%d_%H%M%S)
DB_USER=[用户名]
DB_PASS=[密码]
DB_NAME=[数据库名]

mkdir -p $BACKUP_DIR
mysqldump -u$DB_USER -p$DB_PASS $DB_NAME > $BACKUP_DIR/${DB_NAME}_$DATE.sql
gzip $BACKUP_DIR/${DB_NAME}_$DATE.sql

# 保留30天
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete
```

```bash
# 添加执行权限
chmod +x /opt/backup/backup_db.sh

# 添加定时任务
crontab -e
# 每天凌晨2点备份
0 2 * * * /opt/backup/backup_db.sh
```

#### 2.3.2 应用备份

```bash
# 备份应用
tar -czf /opt/backup/app_$(date +%Y%m%d).tar.gz /opt/[项目名]

# 清理旧备份
find /opt/backup -name "app_*.tar.gz" -mtime +30 -delete
```

---

## 三、故障处理

### 3.1 常见故障

#### 3.1.1 服务无法启动

**可能原因**：
- 端口被占用
- 配置文件错误
- 权限问题

**排查步骤**：

```bash
# 1. 检查端口
netstat -tlnp | grep [端口号]

# 2. 查看错误日志
tail -n 100 /opt/[项目名]/logs/app.log

# 3. 检查配置文件
vim /opt/[项目名]/config/application.yml

# 4. 检查权限
ls -la /opt/[项目名]
```

#### 3.1.2 数据库连接失败

**可能原因**：
- 数据库服务未启动
- 网络问题
- 用户名密码错误

**排查步骤**：

```bash
# 1. 检查数据库服务
systemctl status mysqld

# 2. 测试连接
mysql -h [主机] -u [用户名] -p

# 3. 检查配置
cat /opt/[项目名]/config/application.yml | grep datasource
```

#### 3.1.3 系统响应慢

**可能原因**：
- CPU/内存使用率高
- 数据库慢查询
- 缓存未命中

**排查步骤**：

```bash
# 1. 查看系统资源
top
htop

# 2. 查看数据库慢查询
vim /var/log/mysql/slow.log

# 3. 查看缓存命中率
redis-cli info stats
```

### 3.2 紧急处理

#### 3.2.1 服务重启

```bash
# 重启Nginx
systemctl restart nginx

# 重启应用
systemctl restart [项目名]

# 重启数据库
systemctl restart mysqld

# 重启Redis
systemctl restart redis
```

#### 3.2.2 紧急回滚

```bash
# 1. 停止服务
systemctl stop [项目名]

# 2. 恢复备份
tar -xzf /opt/backup/app_[日期].tar.gz -C /

# 3. 恢复数据库
gunzip /opt/backup/[数据库名]_[日期].sql.gz
mysql -u [用户名] -p [数据库名] < /opt/backup/[数据库名]_[日期].sql

# 4. 启动服务
systemctl start [项目名]
```

---

## 四、性能优化

### 4.1 系统优化

#### 4.1.1 Linux系统参数

```bash
# 修改文件描述符限制
vim /etc/security/limits.conf
```

**添加以下内容**：

```
* soft nofile 65535
* hard nofile 65535
```

#### 4.1.2 Nginx优化

```nginx
# vim /etc/nginx/nginx.conf

worker_processes auto;
worker_connections 65535;
keepalive_timeout 65;
gzip on;
```

### 4.2 数据库优化

#### 4.2.1 索引优化

```sql
-- 查看慢查询
SHOW VARIABLES LIKE 'slow_query%';

-- 分析表
ANALYZE TABLE [表名];

-- 优化表
OPTIMIZE TABLE [表名];
```

#### 4.2.2 配置优化

```ini
# vim /etc/my.cnf

[mysqld]
max_connections = 1000
innodb_buffer_pool_size = 4G
query_cache_size = 128M
```

---

## 五、安全管理

### 5.1 防火墙配置

```bash
# 查看防火墙状态
firewall-cmd --state

# 开放端口
firewall-cmd --zone=public --add-port=80/tcp --permanent
firewall-cmd --zone=public --add-port=443/tcp --permanent

# 重新加载
firewall-cmd --reload

# 查看开放端口
firewall-cmd --list-ports
```

### 5.2 定期更新

```bash
# 更新系统
yum update -y

# 更新Nginx
yum update nginx -y

# 更新MySQL
yum update mysql-server -y
```

---

## 六、附录

### 6.1 常用命令

| 命令 | 说明 |
|------|------|
| systemctl start [服务] | 启动服务 |
| systemctl stop [服务] | 停止服务 |
| systemctl restart [服务] | 重启服务 |
| systemctl status [服务] | 查看服务状态 |
| tail -f [文件] | 实时查看日志 |
| df -h | 查看磁盘空间 |
| free -m | 查看内存使用 |
| top | 查看系统资源 |

### 6.2 联系方式

| 角色 | 姓名 | 联系方式 |
|------|------|---------|
| 运维负责人 | [姓名] | [联系方式] |
| 开发负责人 | [姓名] | [联系方式] |

---

**文档结束**